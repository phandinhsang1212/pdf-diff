const{PDFDocument:PDFDocument}=PDFLib;async function modifyPdf(e,t,l){if(null!=e&&e.length>0){const a=await PDFDocument.load(t);e.map((e=>{null!=e.duplicate&&null!=e.duplicate&&e.duplicate.length>0&&(e.duplicate.push(e.key),e.duplicate=e.duplicate.sort(((e,t)=>t-e)),e.duplicate.pop())}));let i=e.filter((e=>null!=e.duplicate&&null!=e.duplicate&&e.duplicate.length>0)).map((e=>e.duplicate)),n=Array.prototype.concat(...i);n=[...new Set(n)],n=n.sort(((e,t)=>t-e)),n.forEach((e=>{let t=e-1;a.removePage(t)}));const r=await a.save({addDefaultPage:!1});download(r,`${l}_without_duplicate.pdf`,"application/pdf")}}function showZoom(e){let t=document.createElement("canvas"),l=t.getContext("2d");t.height=e.diff.height,t.width=e.diff.width;l.getImageData(0,0,t.width,t.height);let a=document.createElement("div");a.style.width="100%",a.style.height="100%",a.style["place-items"]="center",a.style.display="grid",document.getElementById("my_pdf_viewer").appendChild(a),t.style.display="block",t.style["max-width"]="100%",l.putImageData(e.diff,0,0),a.appendChild(t),document.getElementById("zoom_in").addEventListener("click",(a=>{null!=e.diff&&null!=e.diff&&(l.scale(1.5,1.5),l.drawImage(t,0,0))})),document.getElementById("zoom_out").addEventListener("click",(a=>{null!=e.diff&&null!=e.diff&&(l.scale(.5,.5),l.drawImage(t,0,0))})),$("#static-zoom").modal("toggle")}$(document).on("change","#switch-onoff-0",(function(){myState.diffPageOnly=$(this).prop("checked"),document.querySelectorAll(".same").forEach((e=>{e.classList.toggle("active")}))}));const div=document.getElementById("grid-result");var myState={CSS_UNITS:96/72,diffPageOnly:!1,file1:null,file2:null,img1:[],img2:[],arrayBuffer1:null,arrayBuffer2:null,fileName1:null,fileName2:null,pages1:new Map,pages2:new Map};async function parsePageL(e){myState.file1=null,myState.img1=[];let t=await pdfjsLib.getDocument(e).promise;myState.file1=t;for(let e=1;e<=t.numPages;e++){let l=await parsePage(t,e,myState.pages1),a={key:e,value:l,duplicate:null},i=await detectPdfPageDuplicate(l,myState.img1,$("#download-dup-left"));if(a.duplicate=i,myState.img1.push(a),null==myState.file2){let t=document.createElement("div");t.style["grid-column-start"]=1,t.style["grid-row-start"]=e,document.getElementById("grid-result").appendChild(t);let a=document.createElement("div");a.style.width="100%",a.style.height="100%",a.style.border="solid 1px "+(null==i?"var(--spectrum-global-color-gray-700)":"var(--spectrum-global-color-orange-500)"),a.style.position="relative",t.appendChild(a);let n=document.createElement("div");n.style.position="absolute",n.style.left="0px",n.style.top="0px",n.style.background=null==i?"var(--spectrum-global-color-gray-700)":"var(--spectrum-global-color-orange-500)",n.style.color="rgb(255, 255, 255)",n.style.padding="0px 4px",n.textContent=null==i?e:`${e} #duplicated with page ${i.join(", ")}`,a.appendChild(n);let r=document.createElement("div");r.style.width="100%",r.style.height="100%",r.style["place-items"]="center",r.style.display="grid",a.appendChild(r);let o=document.createElement("canvas");o.width=l.width,o.height=l.height;let d=o.getContext("2d");d.canvas.style.display="block",d.canvas.style["max-width"]="100%",d.putImageData(l,0,0),r.appendChild(o)}}}async function detectPdfPageDuplicate(e,t,l){if(t.length>0){let a=[];for(let i=0;i<t.length;i++){const{width:n,height:r}=e;if(n==t[i].value.width&&r==t[i].value.height){1-pixelmatch(e.data,t[i].value.data,null,n,r)/(n*r)==1&&("none"==l.css("display")&&l.show(),a.push(t[i].key))}}return a.length>0?(a=a.sort(((e,t)=>t-e)),a):null}return null}async function getPage(e,t,l){if(l.get(t))return l.get(t);let a=(async()=>await e.getPage(t))();return l.set(t,a),l.get(t)}async function parsePage(e,t,l){return 1==e.isImage?e.data:getPage(e,t,l).then((async e=>{const t=e.getViewport({scale:1}),l=createCanvas(t.width,t.height),a=l.getContext("2d");return await e.render({canvasContext:a,viewport:t}).promise,a.getImageData(0,0,l.width,l.height)}))}function createCanvas(e,t){if("undefined"!=typeof OffscreenCanvas)return new OffscreenCanvas(e,t);const l=document.createElement("canvas");return l.width=e,l.height=t,l}const loopIndexes=[[0,0],...Array.from({length:9},((e,t)=>[[0,t+1],[t+1,0]])).flat()];async function*parsePair(e,t){const l=e.numPages,a=t.numPages;let i,n;e:for(i=1,n=1;i<=l&&n<=a;){let r;for(const[o,d]of loopIndexes){const s=i+o,c=n+d;if(s>l||c>a)continue;const u=parsePage(e,s,myState.pages1),g=parsePage(t,c,myState.pages2),[m,f]=await Promise.all([u,g]),y=await imgDiff(m,f);if(0!==y.score){if(!("diff"in y))throw new Error("diffResult with non-zero score must have diff image data");if(!(y.score<1)){for(let e=i;e<s;e++)yield{left:e,right:void 0};for(let e=n;e<c;e++)yield{left:void 0,right:e};yield{left:s,right:c,...y},i=s+1,n=c+1;continue e}{const e=Math.max(0,y.score-.1*Math.max(o,d));(!r||e>r.score)&&(r={left:s,right:c,score:e,diff:y.diff})}}}if(r){const{left:e,right:t,diff:l,score:a}=r;for(let t=i;t<e;t++)yield{left:t,right:void 0};for(let e=n;e<t;e++)yield{left:void 0,right:e};yield{left:e,right:t,diff:l,score:a},i=e+1,n=t+1}else yield{left:i,right:void 0},yield{left:void 0,right:n},i+=1,n+=1}for(;i<=l;i++)yield{left:i,right:void 0};for(;n<=a;n++)yield{left:void 0,right:n}}async function imgDiff(e,t){const{width:l,height:a}=e;if(l!==t.width||a!==t.height)return{score:0};const i=new Uint8Array(l*a*4);return{score:1-pixelmatch(e.data,t.data,i,l,a)/(l*a),diff:new ImageData(new Uint8ClampedArray(i),l,a)}}function renderMid(e,t){return new Promise((l=>{if(null!=e.diff&&null!=e.diff){let l=document.createElement("canvas");l.width=e.diff.width,l.height=e.diff.height;let a=l.getContext("2d");a.canvas.style.display="block",a.canvas.style["max-width"]="100%",a.putImageData(e.diff,0,0);let i=document.createElement("div");i.style["grid-column-start"]=2,i.style["grid-row-start"]=t,i.setAttribute("class",1==myState.diffPageOnly?1==e.score?"grid-col same":"grid-col diff":1==e.score?"grid-col same active":"grid-col diff"),i.onclick=function(){showZoom(e)},div.appendChild(i);let n=document.createElement("div");n.style.width="100%",n.style.height="100%",n.style.border=1==e.score?"solid 1px var(--spectrum-global-color-green-700)":"solid 1px var(--spectrum-global-color-red-700)",n.style.position="relative",i.appendChild(n);let r=document.createElement("div");r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.background=1==e.score?"var(--spectrum-global-color-green-700)":"var(--spectrum-global-color-red-700)",r.style.color="rgb(255, 255, 255)",r.style.padding="0px 4px",r.textContent=1==e.score?"Match":"Difference",n.appendChild(r);let o=document.createElement("div");o.style.width="100%",o.style.height="100%",o.style["place-items"]="center",o.style.display="grid",n.appendChild(o),o.appendChild(a.canvas)}else writeNA(2,t);l()}))}function renderLeft(e,t){return new Promise((l=>{if(null!=e.left){let l=myState.img1.find((t=>t.key==e.left)),a=document.createElement("canvas");a.width=l.value.width,a.height=l.value.height;let i=a.getContext("2d");i.canvas.style.display="block",i.canvas.style["max-width"]="100%",i.putImageData(l.value,0,0);let n=document.createElement("div");n.style["grid-column-start"]=1,n.style["grid-row-start"]=t,n.setAttribute("class",1==myState.diffPageOnly?1==e.score?"grid-col same":null==e.right?"":"grid-col diff":1==e.score?"grid-col same active":null==e.right?"":"grid-col diff"),div.appendChild(n);let r=document.createElement("div");r.style.width="100%",r.style.height="100%",r.style.border="solid 1px "+(null==l.duplicate?"var(--spectrum-global-color-gray-700)":"var(--spectrum-global-color-orange-500)"),r.style.position="relative",n.appendChild(r);let o=document.createElement("div");o.style.position="absolute",o.style.left="0px",o.style.top="0px",o.style.background=null==l.duplicate?"var(--spectrum-global-color-gray-700)":"var(--spectrum-global-color-orange-500)",o.style.color="rgb(255, 255, 255)",o.style.padding="0px 4px",o.textContent=null==l.duplicate?e.left:`${e.left} #duplicated with page ${l.duplicate.join(", ")}`,r.appendChild(o);let d=document.createElement("div");d.style.width="100%",d.style.height="100%",d.style["place-items"]="center",d.style.display="grid",r.appendChild(d),d.appendChild(i.canvas)}else writeNA(1,t);l()}))}function renderRight(e,t){return new Promise((l=>{if(null!=e.right){let l=myState.img2.find((t=>t.key==e.right)),a=document.createElement("canvas");a.width=l.value.width,a.height=l.value.height;let i=a.getContext("2d");i.canvas.style.display="block",i.canvas.style["max-width"]="100%",i.putImageData(l.value,0,0);let n=document.createElement("div");n.style["grid-column-start"]=3,n.style["grid-row-start"]=t,n.setAttribute("class",1==myState.diffPageOnly?1==e.score?"grid-col same":null==e.left?"":"grid-col diff":1==e.score?"grid-col same active":null==e.left?"":"grid-col diff"),div.appendChild(n);let r=document.createElement("div");r.style.width="100%",r.style.height="100%",r.style.border="solid 1px "+(null==l.duplicate?"var(--spectrum-global-color-gray-700)":"var(--spectrum-global-color-orange-500)"),r.style.position="relative",n.appendChild(r);let o=document.createElement("div");o.style.position="absolute",o.style.left="0px",o.style.top="0px",o.style.background=null==l.duplicate?"var(--spectrum-global-color-gray-700)":"var(--spectrum-global-color-orange-500)",o.style.color="rgb(255, 255, 255)",o.style.padding="0px 4px",o.textContent=null==l.duplicate?e.right:`${e.right} #duplicated with page ${l.duplicate}`,r.appendChild(o);let d=document.createElement("div");d.style.width="100%",d.style.height="100%",d.style["place-items"]="center",d.style.display="grid",r.appendChild(d),d.appendChild(i.canvas)}else writeNA(3,t);l()}))}async function writeResultToPage(e,t){let l=renderLeft(e,t),a=renderMid(e,t),i=renderRight(e,t);await Promise.all([l,a,i])}function writeNA(e,t){let l=document.createElement("div");l.style["grid-column-start"]=e,l.style["grid-row-start"]=t,div.appendChild(l);let a=document.createElement("div");a.style.width="100%",a.style.height="100%",a.style.border="solid 1px #6e6e6e",a.style.position="relative",l.appendChild(a);let i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.style["place-items"]="center",i.style.display="grid",a.appendChild(i);let n=document.createElement("span");n.style.color="#6e6e6e",n.textContent="N/A",i.appendChild(n)}async function parsePageR(e){myState.file2=null,myState.img2=[];let t=await pdfjsLib.getDocument(e).promise;myState.file2=t;for(let e=1;e<=t.numPages;e++)await t.getPage(e).then((async t=>{let l=t.getViewport({scale:1}),a=document.createElement("canvas"),i=a.getContext("2d"),n={canvasContext:i,viewport:l};a.height=l.height,a.width=l.width;const r=t.render(n);await r.promise.then((async function(){var t=i.getImageData(0,0,a.width,a.height);let l={key:e,value:t,duplicate:null},n=null;if(l.duplicate=n,myState.img2.push(l),null==myState.file1){let l=document.createElement("div");l.style["grid-column-start"]=3,l.style["grid-row-start"]=e,document.getElementById("grid-result").appendChild(l);let n=document.createElement("div");n.style.width="100%",n.style.height="100%",n.style.border="solid 1px var(--spectrum-global-color-gray-700)",n.style.position="relative",l.appendChild(n);let r=document.createElement("div");r.style.position="absolute",r.style.left="0px",r.style.top="0px",r.style.background="var(--spectrum-global-color-gray-700)",r.style.color="rgb(255, 255, 255)",r.style.padding="0px 4px",r.textContent=e,n.appendChild(r);let o=document.createElement("div");o.style.width="100%",o.style.height="100%",o.style["place-items"]="center",o.style.display="grid",n.appendChild(o),a.style.display="block",a.style["max-width"]="100%",i.putImageData(t,0,0),o.appendChild(a)}}))}))}function convertDataURIToBinary(e){for(var t=window.atob(e),l=t.length,a=new Uint8Array(new ArrayBuffer(l)),i=0;i<l;i++)a[i]=t.charCodeAt(i);return a}function renderPDF(e){pdfjsLib.getDocument(e).promise.then((function(e){e.numPages;!function t(){e.getPage(currentPage).then((function(l){var a=l.getViewport({scale:scale}),i=document.getElementById("source1");scale=i.clientWidth/a.width,a=l.getViewport({scale:scale});var n=document.createElement("canvas"),r=n.getContext("2d"),o={canvasContext:r,viewport:a};n.height=a.height,n.width=a.width;l.render(o).promise.then((function(){pages.push(r.getImageData(0,0,n.width,n.height)),heights.push(height),height+=n.height,width<n.width&&(width=n.width),currentPage<e.numPages?(currentPage++,t()):draw()}))}))}()}))}const defaultOptions={threshold:.1,includeAA:!1,alpha:.1,aaColor:[255,255,0],diffColor:[255,0,0],diffColorAlt:null,diffMask:!1};function pixelmatch(e,t,l,a,i,n){if(!isPixelData(e)||!isPixelData(t)||l&&!isPixelData(l))throw new Error("Image data: Uint8Array, Uint8ClampedArray or Buffer expected.");if(e.length!==t.length||l&&l.length!==e.length)throw new Error("Image sizes do not match.");if(e.length!==a*i*4)throw new Error("Image data size does not match width/height.");n=Object.assign({},defaultOptions,n);const r=a*i,o=new Uint32Array(e.buffer,e.byteOffset,r),d=new Uint32Array(t.buffer,t.byteOffset,r);let s=!0;for(let e=0;e<r;e++)if(o[e]!==d[e]){s=!1;break}if(s){if(l&&!n.diffMask)for(let t=0;t<r;t++)drawGrayPixel(e,4*t,n.alpha,l);return 0}const c=35215*n.threshold*n.threshold;let u=0;for(let r=0;r<i;r++)for(let o=0;o<a;o++){const d=4*(r*a+o),s=colorDelta(e,t,d,d);Math.abs(s)>c?n.includeAA||!antialiased(e,o,r,a,i,t)&&!antialiased(t,o,r,a,i,e)?(l&&drawPixel(l,d,...s<0&&n.diffColorAlt||n.diffColor),u++):l&&!n.diffMask&&drawPixel(l,d,...n.aaColor):l&&(n.diffMask||drawGrayPixel(e,d,n.alpha,l))}return u}function isPixelData(e){return ArrayBuffer.isView(e)&&1===e.constructor.BYTES_PER_ELEMENT}function antialiased(e,t,l,a,i,n){const r=Math.max(t-1,0),o=Math.max(l-1,0),d=Math.min(t+1,a-1),s=Math.min(l+1,i-1),c=4*(l*a+t);let u,g,m,f,y=t===r||t===d||l===o||l===s?1:0,p=0,h=0;for(let i=r;i<=d;i++)for(let n=o;n<=s;n++){if(i===t&&n===l)continue;const r=colorDelta(e,e,c,4*(n*a+i),!0);if(0===r){if(y++,y>2)return!1}else r<p?(p=r,u=i,g=n):r>h&&(h=r,m=i,f=n)}return 0!==p&&0!==h&&(hasManySiblings(e,u,g,a,i)&&hasManySiblings(n,u,g,a,i)||hasManySiblings(e,m,f,a,i)&&hasManySiblings(n,m,f,a,i))}function hasManySiblings(e,t,l,a,i){const n=Math.max(t-1,0),r=Math.max(l-1,0),o=Math.min(t+1,a-1),d=Math.min(l+1,i-1),s=4*(l*a+t);let c=t===n||t===o||l===r||l===d?1:0;for(let i=n;i<=o;i++)for(let n=r;n<=d;n++){if(i===t&&n===l)continue;const r=4*(n*a+i);if(e[s]===e[r]&&e[s+1]===e[r+1]&&e[s+2]===e[r+2]&&e[s+3]===e[r+3]&&c++,c>2)return!0}return!1}function colorDelta(e,t,l,a,i){let n=e[l+0],r=e[l+1],o=e[l+2],d=e[l+3],s=t[a+0],c=t[a+1],u=t[a+2],g=t[a+3];if(d===g&&n===s&&r===c&&o===u)return 0;d<255&&(d/=255,n=blend(n,d),r=blend(r,d),o=blend(o,d)),g<255&&(g/=255,s=blend(s,g),c=blend(c,g),u=blend(u,g));const m=rgb2y(n,r,o),f=rgb2y(s,c,u),y=m-f;if(i)return y;const p=rgb2i(n,r,o)-rgb2i(s,c,u),h=rgb2q(n,r,o)-rgb2q(s,c,u),w=.5053*y*y+.299*p*p+.1957*h*h;return m>f?-w:w}function rgb2y(e,t,l){return.29889531*e+.58662247*t+.11448223*l}function rgb2i(e,t,l){return.59597799*e-.2741761*t-.32180189*l}function rgb2q(e,t,l){return.21147017*e-.52261711*t+.31114694*l}function blend(e,t){return 255+(e-255)*t}function drawPixel(e,t,l,a,i){e[t+0]=l,e[t+1]=a,e[t+2]=i,e[t+3]=255}function drawGrayPixel(e,t,l,a){const i=blend(rgb2y(e[t+0],e[t+1],e[t+2]),l*e[t+3]/255);drawPixel(a,t,i,i,i)}async function parseImageL(e,t){myState.file1=null,myState.img1=[];let l={numPages:1,isImage:!0,data:e};myState.file1=l;let a={key:1,value:e,duplicate:null},i=null;if(a.duplicate=i,myState.img1.push(a),null==myState.file2){let e=document.createElement("div");e.style["grid-column-start"]=1,e.style["grid-row-start"]=1,document.getElementById("grid-result").appendChild(e);let l=document.createElement("div");l.style.width="100%",l.style.height="100%",l.style.border="solid 1px var(--spectrum-global-color-gray-700)",l.style.position="relative",e.appendChild(l);let a=document.createElement("div");a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.background="var(--spectrum-global-color-gray-700)",a.style.color="rgb(255, 255, 255)",a.style.padding="0px 4px",a.textContent=1,l.appendChild(a);let i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.style["place-items"]="center",i.style.display="grid",l.appendChild(i),t.style.display="block",t.style["max-width"]="100%",i.appendChild(t)}}async function parseImageR(e,t){myState.file2=null,myState.img2=[];let l={numPages:1,isImage:!0,data:e};myState.file2=l;let a={key:1,value:e,duplicate:null},i=null;if(a.duplicate=i,myState.img2.push(a),null==myState.file1){let e=document.createElement("div");e.style["grid-column-start"]=1,e.style["grid-row-start"]=1,document.getElementById("grid-result").appendChild(e);let l=document.createElement("div");l.style.width="100%",l.style.height="100%",l.style.border="solid 1px var(--spectrum-global-color-gray-700)",l.style.position="relative",e.appendChild(l);let a=document.createElement("div");a.style.position="absolute",a.style.left="0px",a.style.top="0px",a.style.background="var(--spectrum-global-color-gray-700)",a.style.color="rgb(255, 255, 255)",a.style.padding="0px 4px",a.textContent=1,l.appendChild(a);let i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.style["place-items"]="center",i.style.display="grid",l.appendChild(i),t.style.display="block",t.style["max-width"]="100%",i.appendChild(t)}}function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?document.getElementById("movetop").style.display="block":document.getElementById("movetop").style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}$(".preload").addClass("d-flex"),window.onscroll=function(){scrollFunction()},$("#file1").FancyFileUpload({params:{action:"fileuploader"},maxfilesize:25e6,added:async function(e,t){switch(div.innerHTML="",$("#download-dup-left").hide(),myState.arrayBuffer1=null,myState.img1=[],myState.pages1=new Map,myState.fileName1=t[0].name,t[0].type){case"image/png":case"image/jpg":case"image/jpeg":case"image/x-icon":const e=new FileReader;e.readAsDataURL(t[0]);var l=document.createElement("canvas"),a=l.getContext("2d");return void(e.onloadend=function(){const i=e.result.split(",");var n=new Image;n.src=`data:${t[0].type};base64,`+i[1],n.onload=async function(){a.drawImage(n,0,0,l.width,l.height);var e=a.getImageData(0,0,l.width,l.height);if(await parseImageL(e,l),null!=myState.file1&&null!=myState.file1&&null!=myState.file2&&null!=myState.file2){let e=1;(async()=>{for await(const t of parsePair(myState.file1,myState.file2))writeResultToPage(t,e),e++})()}}});case"image/tiff":let r=await t[0].arrayBuffer(),o=new Tiff({buffer:r}).toCanvas();var i=o.getContext("2d").getImageData(0,0,o.width,o.height);if(await parseImageL(i,o),null!=myState.file1&&null!=myState.file1&&null!=myState.file2&&null!=myState.file2){let e=1;(async()=>{for await(const t of parsePair(myState.file1,myState.file2))writeResultToPage(t,e),e++})()}return;default:let d=t[0].arrayBuffer(),s=t[0].arrayBuffer(),c=await Promise.all([d,s]).then((e=>e));var n=c[0];if(myState.arrayBuffer1=c[1],await parsePageL(n),null!=myState.file1&&null!=myState.file1&&null!=myState.file2&&null!=myState.file2){let e=1;(async()=>{for await(const t of parsePair(myState.file1,myState.file2))writeResultToPage(t,e),e++})()}}},deleted:function(e,t){}}),$("#file2").FancyFileUpload({params:{action:"fileuploader"},maxfilesize:25e6,added:async function(e,t){switch(div.innerHTML="",myState.arrayBuffer2=null,myState.img2=[],myState.pages2=new Map,t[0].type){case"image/png":case"image/jpg":case"image/jpeg":case"image/tiff":case"image/x-icon":const e=new FileReader;e.readAsDataURL(t[0]);var l=document.createElement("canvas"),a=l.getContext("2d");return void(e.onloadend=function(){const i=e.result.split(",");var n=new Image;n.src=`data:${t[0].type};base64,`+i[1],n.onload=async function(){a.drawImage(n,0,0,l.width,l.height);var e=a.getImageData(0,0,l.width,l.height);if(await parseImageR(e,l),null!=myState.file1&&null!=myState.file1&&null!=myState.file2&&null!=myState.file2){let e=1;(async()=>{for await(const t of parsePair(myState.file1,myState.file2))writeResultToPage(t,e),e++})()}}});default:let n=t[0].arrayBuffer(),r=t[0].arrayBuffer(),o=await Promise.all([n,r]).then((e=>e));var i=o[0];if(myState.arrayBuffer2=o[1],await parsePageR(i),null!=myState.file1&&null!=myState.file1&&null!=myState.file2&&null!=myState.file2){let e=1;(async()=>{for await(const t of parsePair(myState.file1,myState.file2))writeResultToPage(t,e),e++})()}}},deleted:function(e,t){}});